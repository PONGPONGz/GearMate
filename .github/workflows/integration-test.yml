name: Flutter Integration Tests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  integration-tests:
    name: Flutter Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: gearmate
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptestpassword --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done
      
      - name: Create .env file for API
        working-directory: ./api
        run: |
          cat > .env << EOF
          HOST=0.0.0.0
          PORT=8000
          DEBUG=True
          DB_USER=root
          DB_PASSWORD=testpassword
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_NAME=gearmate
          EOF
      
      - name: Start FastAPI backend
        working-directory: ./api
        run: |
          # FastAPI will create tables automatically via models.Base.metadata.create_all()
          python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo $! > api.pid
          echo "Backend API started with PID $(cat api.pid)"
      
      - name: Wait for API to be ready
        run: |
          echo "Waiting for API health check..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "API is ready!"
              curl http://localhost:8000/health
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done
          # Verify API is actually responding
          curl -f http://localhost:8000/health || (echo "API health check failed" && exit 1)
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Enable KVM (for Android emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      
      - name: Flutter doctor
        run: flutter doctor -v
      
      - name: Install Flutter dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true
      
      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true
      
      - name: Set up Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: echo "Emulator started"
      
      - name: Update integration tests to use localhost
        working-directory: ./client
        run: |
          # Create a backup and update API URLs for CI environment
          find integration_test -type f -name "*.dart" -exec sed -i.bak 's|http://10.0.2.2:8000|http://10.0.2.2:8000|g' {} \;
          find integration_test -type f -name "*.dart" -exec sed -i.bak 's|http://127.0.0.1:8000|http://10.0.2.2:8000|g' {} \;
          find integration_test -type f -name "*.dart" -exec sed -i.bak 's|http://localhost:8000|http://10.0.2.2:8000|g' {} \;
          echo "Updated API URLs to use 10.0.2.2 for Android emulator"
      
      - name: Run Flutter integration tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: |
            cd client
            flutter test --dart-define=DISABLE_NOTIFICATIONS=true integration_test
      
      - name: Stop backend API
        if: always()
        working-directory: ./api
        run: |
          if [ -f api.pid ]; then
            kill $(cat api.pid) || true
            rm api.pid
          fi
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            client/test-results/
            client/screenshots/
          retention-days: 7
