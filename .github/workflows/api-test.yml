name: API Unit Tests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  backend-tests:
    name: Backend Unit Tests & Coverage
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: gearmate
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Create .env file for backend tests
        working-directory: ./api
        run: |
          cat > .env << EOF
          HOST=0.0.0.0
          PORT=8000
          DEBUG=True
          DB_USER=root
          DB_PASSWORD=testpassword
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_NAME=gearmate
          EOF
          echo ".env file created for backend tests"
      
      - name: Run backend unit tests with coverage
        working-directory: .
        run: |
          pytest unitTest -v \
            --cov=routers.firefighters \
            --cov=routers.stations \
            --cov=routers.inspections \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            --cov-branch
        env:
          PYTHONPATH: ${{ github.workspace }}/api
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30
      
      - name: Display coverage summary
        run: |
          echo "### Backend Unit Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          coverage report -m || echo "Coverage report not available" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Parse coverage and create PR comment
        if: github.event_name == 'pull_request'
        id: coverage
        run: |
          python << 'EOF'
          import xml.etree.ElementTree as ET
          import os
          
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          
          # Extract overall coverage
          overall_line_rate = float(root.attrib.get('line-rate', 0)) * 100
          overall_branch_rate = float(root.attrib.get('branch-rate', 0)) * 100
          
          # Extract per-file coverage
          packages = root.findall('.//package')
          
          comment = "## ðŸ“Š Backend Unit Test Coverage Report\n\n"
          comment += f"**Overall Coverage:** {overall_line_rate:.2f}% (Lines) | {overall_branch_rate:.2f}% (Branches)\n\n"
          comment += "### Coverage by Module\n\n"
          comment += "| Module | Line Coverage | Branch Coverage |\n"
          comment += "|--------|---------------|------------------|\n"
          
          for package in packages:
              for cls in package.findall('.//class'):
                  filename = cls.attrib.get('filename', '')
                  if any(module in filename for module in ['firefighters', 'stations', 'inspections']):
                      line_rate = float(cls.attrib.get('line-rate', 0)) * 100
                      branch_rate = float(cls.attrib.get('branch-rate', 0)) * 100
                      module_name = filename.split('/')[-1].replace('.py', '')
                      
                      # Add emoji based on coverage
                      line_emoji = "âœ…" if line_rate >= 80 else "âš ï¸" if line_rate >= 60 else "âŒ"
                      branch_emoji = "âœ…" if branch_rate >= 80 else "âš ï¸" if branch_rate >= 60 else "âŒ"
                      
                      comment += f"| `{module_name}` | {line_emoji} {line_rate:.2f}% | {branch_emoji} {branch_rate:.2f}% |\n"
          
          comment += "\n### Test Results\n\n"
          comment += "- âœ… All backend unit tests passed\n"
          comment += "\n---\n"
          comment += "*Coverage report generated automatically after API tests*"
          
          # Write to file for GitHub comment
          with open('coverage_comment.txt', 'w') as f:
              f.write(comment)
          
          print(f"Overall Line Coverage: {overall_line_rate:.2f}%")
          print(f"Overall Branch Coverage: {overall_branch_rate:.2f}%")
          EOF
      
      - name: Post coverage comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageComment = fs.readFileSync('coverage_comment.txt', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“Š Backend Unit Test Coverage Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: coverageComment
              });
              console.log('Updated existing coverage comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageComment
              });
              console.log('Created new coverage comment');
            }
